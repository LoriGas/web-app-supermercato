<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YourNextMarket</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { 
            /* THEME: YourNextMarket Blue */
            --primary: #0055ff;
            --primary-dark: #003db3;
            --accent: #00d4ff;
            --bg: #f4f6f9; 
            --text: #1a1a1a;
            --white: #ffffff;
            --danger: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --input-bg: #f7f9fc;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-font-smoothing: antialiased; }
        
        /* --- AUTH SCREENS --- */
        .auth-page { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
            z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 25px; box-sizing: border-box; transition: opacity 0.3s;
        }
        .hidden-auth { display: none !important; }

        .brand-logo-anim {
            width: 80px; height: 80px; background: var(--primary); border-radius: 24px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 40px; margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 85, 255, 0.25); animation: float 3s ease-in-out infinite;
        }

        .login-card { 
            background: white; width: 100%; max-width: 340px; border-radius: 28px; padding: 40px 30px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.06); text-align: center; border: 1px solid rgba(0,0,0,0.02);
        }
        .login-title { font-size: 26px; font-weight: 800; color: var(--text); margin: 0 0 8px 0; letter-spacing: -0.5px;}
        .login-subtitle { font-size: 15px; color: #888; margin-bottom: 30px; line-height: 1.4; }

        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 20px; pointer-events: none; transition: color 0.2s; }
        .login-input { 
            width: 100%; padding: 18px 18px 18px 50px; border: 2px solid transparent; background: var(--input-bg);
            border-radius: 18px; box-sizing: border-box; font-size: 16px; outline: none; transition: all 0.2s; font-weight: 600; color: var(--text);
        }
        .login-input:focus { border-color: var(--primary); background: white; box-shadow: 0 4px 15px rgba(0,85,255,0.05); }
        .login-input:focus + i { color: var(--primary); }

        .login-btn { 
            width: 100%; padding: 20px; background: var(--text); color: white; border: none; border-radius: 18px; font-weight: 700; font-size: 16px; cursor: pointer; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 15px; letter-spacing: 0.5px; transition: transform 0.1s;
        }
        .login-btn.accent { background: var(--primary); box-shadow: 0 10px 25px rgba(0, 85, 255, 0.25); }
        .login-btn:active { transform: scale(0.98); }
        .switch-auth-link { margin-top: 25px; font-size: 14px; color: #666; cursor: pointer; padding: 10px;}
        .switch-auth-link b { color: var(--primary); font-weight: 700; }

        /* --- HEADER & WIDGET FIX --- */
        header { 
            background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px); 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }

        .app-logo { 
            font-size: 20px; 
            font-weight: 900; 
            color: var(--primary); 
            letter-spacing: -0.5px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap; 
        }
        
        .crowd-widget { 
            display: flex; 
            align-items: center; 
            background: #eef2ff; 
            color: var(--primary-dark); 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            border: 1px solid rgba(0, 85, 255, 0.1); 
            white-space: nowrap; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .dot { 
            height: 8px; 
            width: 8px; 
            min-width: 8px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
            box-shadow: 0 0 5px rgba(46, 213, 115, 0.5); 
            transition: background 0.5s, box-shadow 0.5s; 
            flex-shrink: 0; 
        }

        @media (max-width: 370px) {
            .app-logo { font-size: 18px; }
            .crowd-widget { font-size: 10px; padding: 5px 10px; }
            header { padding: 15px 10px; }
        }

        /* --- LAYOUT --- */
        .page { display: none; padding: 15px; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        .subpage { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; overflow-y: auto; padding: 20px; box-sizing: border-box; animation: slideIn 0.3s ease-out; }
        .subpage.active { display: block; }
        .subpage-header { display: flex; align-items: center; margin-bottom: 25px; }
        .btn-back { background: white; border: none; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); cursor: pointer; }
        
        /* --- EXIT PAGE --- */
        #page-exit { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; flex-direction: column; align-items: center; justify-content: center; padding: 30px; box-sizing: border-box; text-align: center; }
        #page-exit.active { display: flex; }
        .exit-icon { font-size: 80px; color: var(--success); margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(46, 213, 115, 0.3)); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; } }

        h2 { font-size: 22px; margin-bottom: 15px; font-weight: 800; color: #111; }

        /* --- CARDS --- */
        .gastro-banner { background: white; padding: 20px; border-radius: 20px; margin-bottom: 25px; border: 1px solid #ffefe0; box-shadow: 0 5px 20px rgba(255, 112, 67, 0.08); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .gastro-banner:active { transform: scale(0.98); }
        .card { background: var(--white); border-radius: 18px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03); }
        .card-icon { width: 50px; height: 50px; background: #f0f4ff; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: var(--primary); flex-shrink: 0; }
        .card .info { flex-grow: 1; }
        .card .name { font-weight: 700; font-size: 15px; margin-bottom: 4px; color: #222; }
        .price { color: #222; font-weight: 800; font-size: 17px; }
        .price.discounted { color: var(--danger); }
        .old-price { text-decoration: line-through; color: #bbb; font-size: 11px; margin-right: 5px; }
        .btn-map-mini { padding: 6px 12px; background: #f0f4ff; border-radius: 20px; border:none; color: var(--primary); font-weight: 700; font-size: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; margin-top: 5px; }

        .food-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .food-item { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #eee; }
        .food-img-ph { height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; color: #aaa; }
        .food-info { padding: 12px; }
        .food-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .food-btn { width: 100%; padding: 8px; background: var(--warning); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 8px;}

        /* --- MAPPA COMPLESSA --- */
        #map-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(8px); }
        #map-modal.active { display: flex; }
        .map-frame { background: white; width: 95%; max-width: 400px; border-radius: 28px; padding: 20px; position: relative; }
        .supermarket-floor { position: relative; width: 100%; height: 450px; background: #f4f6f9; border: 3px solid #333; border-radius: 8px; margin-top: 15px; overflow: hidden; }
        .shelf-block { position: absolute; border-radius: 3px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 8px; font-weight: 800; color: rgba(255,255,255,0.95); line-height: 1.1; box-shadow: 0 2px 4px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.1); }
        .zone-green { background: #4cd137; border-bottom: 3px solid #44bd32; } 
        .zone-blue { background: #00a8ff; border-bottom: 3px solid #0097e6; } 
        .zone-red { background: #e84118; border-bottom: 3px solid #c23616; } 
        .zone-orange { background: #fbc531; border-bottom: 3px solid #e1b12c; } 
        .zone-gray { background: #7f8c8d; border-bottom: 3px solid #2c3e50; } 
        .zone-purple { background: #9c88ff; border-bottom: 3px solid #8c7ae6; } 
        .checkout-zone { position: absolute; bottom: 0; right: 0; width: 25%; height: 15%; background: #dfe6e9; border-top-left-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: #636e72; border-left: 1px solid #b2bec3; border-top: 1px solid #b2bec3; }
        .entrance-zone { position: absolute; bottom: 0; left: 40%; width: 20%; height: 5px; background: var(--success); }
        .pin-target { width: 24px; height: 24px; background: var(--danger); border: 3px solid white; border-radius: 50%; position: absolute; z-index: 30; box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); transform: translate(-50%, -50%); animation: pulse 1.5s infinite; display: none; }
        .pin-user { width: 14px; height: 14px; background: var(--primary); border: 2px solid white; border-radius: 50%; position: absolute; z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transform: translate(-50%, -50%); }

        /* --- PROFILO & LISTE --- */
        .profile-header { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #ddd, #f0f0f0); border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #888; border: 4px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .menu-item { padding: 18px; border-bottom: 1px solid #f5f5f5; display:flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .menu-item:active { background: #fafafa; }
        .order-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #eee; }
        .order-head { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 10px; font-size: 10px; text-transform: uppercase; }
        .status-done { background: #dcfce7; color: #166534; }
        .status-pending { background: #fff3cd; color: #856404; }

        /* --- NAVBAR --- */
        .navbar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; padding: 10px 0 30px 0; z-index: 150; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; color: #ccc; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 26px; margin-bottom: 2px; display: block; }
        .nav-item span { font-size: 10px; font-weight: 600; }

        /* Utils */
        .hidden { display: none !important; }
        .qty-box { display: flex; align-items: center; background: #f0f2f5; border-radius: 10px; padding: 4px; }
        .qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--primary); cursor: pointer; background: white; border-radius: 8px; }
        
        #scan-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            border: 4px solid var(--success); box-sizing: border-box; 
            z-index: 50; display: none; align-items: center; justify-content: center;
            box-shadow: inset 0 0 50px rgba(46, 213, 115, 0.5); pointer-events: none;
        }
        .scan-tick { font-size: 100px; color: var(--success); animation: popIn 0.3s ease-out forwards; filter: drop-shadow(0 0 10px rgba(46, 213, 115, 0.5)); }

        /* --- SERVICE MODAL STYLES --- */
        .service-option {
            background: white; border: 2px solid #eee; border-radius: 16px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; cursor: pointer; transition: all 0.2s;
        }
        .service-option:active, .service-option.selected { border-color: var(--primary); background: #f0f4ff; }
        .service-icon { 
            width: 40px; height: 40px; background: #f5f5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #666; margin-right: 15px; flex-shrink: 0;
        }
        .service-option.selected .service-icon { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="view-login" class="auth-page">
    <div class="brand-logo-anim"><i class="material-icons">storefront</i></div>
    <div class="login-card">
        <div class="login-title">Bentornato</div>
        <p class="login-subtitle">Accedi per continuare la tua spesa smart.</p>
        <div class="input-group"><input type="email" id="login-email" class="login-input" placeholder="Email"><i class="material-icons">alternate_email</i></div>
        <div class="input-group"><input type="password" id="login-pass" class="login-input" placeholder="Password"><i class="material-icons">lock_outline</i></div>
        <button class="login-btn accent" onclick="performLogin()">ACCEDI</button>
        <div class="switch-auth-link" onclick="toggleAuth('register')">Non hai un account? <b>Registrati</b></div>
    </div>
</div>

<div id="view-register" class="auth-page hidden-auth">
    <div class="brand-logo-anim" style="background:var(--accent)"><i class="material-icons">person_add</i></div>
    <div class="login-card">
        <div class="login-title">Crea Account</div>
        <p class="login-subtitle">Unisciti a YourNextMarket oggi stesso.</p>
        <div class="input-group"><input type="text" id="reg-name" class="login-input" placeholder="Il tuo nome"><i class="material-icons">badge</i></div>
        <div class="input-group"><input type="email" id="reg-email" class="login-input" placeholder="Email"><i class="material-icons">alternate_email</i></div>
        <div class="input-group"><input type="password" id="reg-pass" class="login-input" placeholder="Crea password"><i class="material-icons">lock_outline</i></div>
        <button class="login-btn accent" onclick="performRegister()">CREA ACCOUNT</button>
        <div class="switch-auth-link" onclick="toggleAuth('login')">Hai già un account? <b>Accedi</b></div>
    </div>
</div>

<header id="main-header" class="hidden">
    <div class="app-logo"><i class="material-icons">storefront</i> YourNextMarket</div>
    <div class="crowd-widget">
        <span class="dot" style="background: #2ed573;"></span>
        <span id="crowd-status">Affluenza: ...</span>
    </div>
</header>

<div id="page-offers" class="page">
    <div style="margin-top:10px;"></div>
    <div class="gastro-banner" onclick="openSubPage('booking')">
        <div>
            <div style="font-weight: 800; font-size: 18px; color:#d35400">Gastronomia</div>
            <div style="font-size: 12px; color: #666; margin-top:2px;">Salta la fila: prenota pasti caldi e freschi</div>
        </div>
        <div style="background:#fff3e0; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#d35400">
            <i class="material-icons">restaurant_menu</i>
        </div>
    </div>
    <h2>Offerte per te</h2>
    <div id="offers-list"></div>
</div>

<div id="page-search" class="page">
    <div style="position: sticky; top: 0; background: var(--bg); padding-bottom: 10px; z-index: 10;">
        <input type="text" style="width:100%; padding:14px; border-radius:14px; border:none; box-shadow:0 4px 15px rgba(0,0,0,0.05); font-size:16px;" id="search-box" placeholder="Cerca tra 30+ prodotti..." onkeyup="filterProducts()">
    </div>
    <div id="products-list" style="margin-top: 15px;"></div>
</div>

<div id="page-scanner" class="page">
    <div style="text-align: center; padding: 20px;">
        <h2 style="margin:0;">Scanner</h2>
        <p style="color:#888; font-size:14px;">Inquadra il codice a barre</p>
    </div>
    <div style="position: relative; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); background: black;">
        <div id="reader" style="width:100%;"></div>
        <div id="scan-overlay"><i class="material-icons scan-tick">check_circle</i></div> 
    </div>
    <div id="scan-feedback" style="text-align: center; margin-top: 20px; font-weight: bold; height: 20px;"></div>
    <div style="margin-top: 30px; text-align: center;">
        <p style="font-size:10px; color:#aaa; font-weight: bold;">DEBUG TOOLS</p>
        <button onclick="simulateScan('8076809513753')" style="padding: 8px 15px; background: #e0e0e0; border:none; border-radius: 20px;">Pasta</button>
        <button onclick="simulateScan('8000500003787')" style="padding: 8px 15px; background: #e0e0e0; border:none; border-radius: 20px;">Nutella</button>
        <button onclick="simulateScan('8002270014901')" style="padding: 8px 15px; background: #e0e0e0; border:none; border-radius: 20px;">Acqua</button>
    </div>
</div>

<div id="page-cart" class="page">
    <h2>Il tuo Carrello</h2>
    <div id="cart-list"></div>
    <div id="cart-footer" class="hidden" style="margin-top: 30px;">
        <div style="background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08);">
            <div style="display:flex; justify-content:space-between; font-size: 20px; font-weight: 800; margin-bottom: 20px;">
                <span>Totale</span>
                <span id="total-price" style="color:var(--primary)">€ 0.00</span>
            </div>
            <button onclick="pay()" style="width:100%; background: var(--text); color:white; padding: 18px; border-radius: 16px; font-weight: bold; border:none;">PAGA</button>
        </div>
    </div>
</div>

<div id="page-profile" class="page">
    <div class="profile-header">
        <div class="avatar"><i class="material-icons">person</i></div>
        <h2 id="user-name-display" style="margin-bottom: 5px; font-size: 24px;">Utente</h2>
        <p id="user-email-display" style="color:#888; margin:0;">--</p>
    </div>
    <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.03);">
        <div class="menu-item" onclick="openSubPage('orders')"><span style="font-weight: 500;">Le mie spese</span> <i class="material-icons" style="color:#ddd">chevron_right</i></div>
        <div class="menu-item" onclick="openSubPage('reservations')"><span style="font-weight: 500;">Prenotazioni Gastronomia</span> <i class="material-icons" style="color:#ddd">chevron_right</i></div>
        <div class="menu-item" onclick="openSubPage('payments')"><span style="font-weight: 500;">Metodi di Pagamento</span> <i class="material-icons" style="color:#ddd">chevron_right</i></div>
        <div class="menu-item" onclick="doLogout()" style="color: var(--danger);"><span style="font-weight: 700;">Esci dall'app</span> <i class="material-icons">logout</i></div>
    </div>
</div>

<div id="sub-booking" class="subpage" style="z-index: 250;">
    <div class="subpage-header"><button class="btn-back" onclick="closeSubPage()"><i class="material-icons">arrow_back</i></button><h2>Prenota Pasti</h2></div>
    <p style="color:#666; font-size:14px; margin-bottom:20px;">Prenota prodotti freschi e ritirali al banco gastronomia.</p>
    <label style="font-weight:bold; font-size:12px; text-transform:uppercase; color:#888;">Quando ritiri?</label>
    <input type="time" id="booking-time" value="13:00" style="display:block; width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-top:5px; margin-bottom:20px; font-size:16px;">
    <div class="food-grid" id="fresh-list"></div>
</div>

<div id="sub-reservations" class="subpage">
    <div class="subpage-header"><button class="btn-back" onclick="closeSubPage()"><i class="material-icons">arrow_back</i></button><h2>Le tue Prenotazioni</h2></div>
    <div id="my-reservations-list"><div style="text-align:center; color:#999; margin-top:40px;">Nessuna prenotazione attiva</div></div>
</div>

<div id="sub-orders" class="subpage">
    <div class="subpage-header"><button class="btn-back" onclick="closeSubPage()"><i class="material-icons">arrow_back</i></button><h2>Storico Spese</h2></div>
    <div id="history-list"></div>
</div>

<div id="sub-payments" class="subpage">
    <div class="subpage-header"><button class="btn-back" onclick="closeSubPage()"><i class="material-icons">arrow_back</i></button><h2>Metodi di Pagamento</h2></div>
    <div class="card" style="justify-content: space-between;">
        <div style="display:flex; align-items:center;">
            <i class="material-icons" style="font-size:30px; margin-right:15px; color:#1a1a1a;">credit_card</i>
            <div><div style="font-weight:bold;">Mastercard **** 4455</div><div style="font-size:11px; color:#888;">Scade il 09/25</div></div>
        </div>
        <i class="material-icons" style="color:var(--success)">check_circle</i>
    </div>
</div>

<div id="map-modal">
    <div class="map-frame">
        <h3 style="text-align:center; margin-top:0;">Mappa Supermercato</h3>
        <div class="supermarket-floor">
            <div class="shelf-block zone-green" style="bottom:10%; left:0; width:30%; height:25%;">ORTOFRUTTA<br><i class="material-icons" style="font-size:14px">grass</i></div>
            <div class="shelf-block zone-blue" style="top:25%; left:0; width:15%; height:40%;">FRIGO<br>LATTICINI</div>
            <div class="shelf-block zone-orange" style="top:0; left:20%; width:25%; height:20%;">FORNO<br>PANE</div>
            <div class="shelf-block zone-red" style="top:0; right:20%; width:25%; height:20%;">MACELLERIA<br>PESCHERIA</div>
            
            <div class="shelf-block zone-gray" style="top:35%; left:25%; width:12%; height:35%;">PASTA &<br>SUGHI</div>
            <div class="shelf-block zone-gray" style="top:35%; left:44%; width:12%; height:35%;">DOLCI &<br>CAFFÈ</div>
            <div class="shelf-block zone-gray" style="top:35%; left:63%; width:12%; height:35%;">CURA &<br>PULIZIA</div>

            <div class="shelf-block zone-blue" style="bottom:20%; right:0; width:15%; height:30%;">BIBITE<br>& VINI</div>
            <div class="shelf-block zone-purple" style="top:30%; right:0; width:15%; height:30%;">TECH<br>& CASA</div>
            <div class="entrance-zone"></div>
            <div style="position:absolute; bottom:6px; left:45%; font-size:8px; font-weight:bold;">ENTRATA</div>
            <div class="checkout-zone">CASSE</div>
            <div class="pin-user" style="bottom:15%; left:50%;"></div>
            <div id="target-pin" class="pin-target"></div>
        </div>
        <div style="text-align:center; font-size:10px; color:#666; margin-top:10px;">Tu sei il puntino blu.</div>
        <button onclick="closeMap()" style="width:100%; padding:15px; margin-top:15px; background:#1a1a1a; color:white; border:none; border-radius: 16px; font-weight: bold;">Chiudi Mappa</button>
    </div>
</div>

<div id="service-modal" class="auth-page" style="display:none; background: rgba(0,0,0,0.8); z-index: 1000; backdrop-filter: blur(5px);">
    <div class="login-card" style="max-width: 320px;">
        <i class="material-icons" style="font-size: 50px; color: var(--primary); margin-bottom: 10px;">shopping_bag</i>
        <h2 style="font-size: 22px; margin-bottom: 10px;">Spesa Completata!</h2>
        <p style="color:#666; margin-bottom: 20px;">Vuoi scegliere uno dei servizi aggiuntivi?</p>
        
        <div class="service-option" onclick="processServiceChoice('none')">
            <div class="service-icon"><i class="material-icons">exit_to_app</i></div>
            <div style="text-align:left;">
                <div style="font-weight:bold;">No, esco da solo</div>
                <div style="font-size:11px; color:#888;">Esci col carrello</div>
            </div>
        </div>

        <div class="service-option" onclick="processServiceChoice('car')">
            <div class="service-icon"><i class="material-icons">directions_car</i></div>
            <div style="text-align:left;">
                <div style="font-weight:bold;">Carico in Auto</div>
                <div style="font-size:11px; color:#888;">Lascia il carrello e ritira</div>
            </div>
        </div>

        <div class="service-option" onclick="processServiceChoice('delivery')">
            <div class="service-icon"><i class="material-icons">local_shipping</i></div>
            <div style="text-align:left;">
                <div style="font-weight:bold;">Consegna a Casa</div>
                <div style="font-size:11px; color:#888;">Lascia il carrello e vai</div>
            </div>
        </div>

        <div id="cart-input-step" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <div id="grp-cart">
                <p style="font-size:14px; font-weight:bold;">Inserisci il numero del carrello:</p>
                <input type="number" id="service-cart-number" class="login-input" placeholder="Es. 104" style="text-align:center; font-size:20px;">
            </div>
            
            <div id="grp-address" style="display:none; margin-top:10px;">
                <p style="font-size:14px; font-weight:bold;">Indirizzo di spedizione:</p>
                <input type="text" id="service-address" class="login-input" placeholder="Via Roma 1, Milano" style="font-size:16px;">
            </div>

            <button class="login-btn accent" onclick="confirmServiceWithCart()">CONFERMA</button>
        </div>
    </div>
</div>

<div id="page-exit">
    <i class="material-icons exit-icon">check_circle</i>
    <h2 id="exit-title" style="font-size:28px; margin-bottom:10px;">Tutto Fatto!</h2>
    <p id="exit-msg" style="color:#666;">Scansiona questo codice al tornello per uscire.</p>
    <div style="margin: 30px 0; padding:15px; background:white; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid #eee;">
        <img id="qr-exit-img" src="" alt="QR Uscita" style="width: 220px; display:block;">
    </div>
    <button onclick="finishShopping()" style="padding: 15px 40px; border-radius: 30px; border: none; background: #f0f0f0; color: #555; font-weight: bold; font-size:16px;">CHIUDI E TORNA ALLA HOME</button>
</div>

<div id="navbar" class="navbar hidden">
    <div class="nav-item active" onclick="switchTab('offers')"><i class="material-icons">local_offer</i><span>Home</span></div>
    <div class="nav-item" onclick="switchTab('search')"><i class="material-icons">search</i><span>Cerca</span></div>
    <div class="nav-item" onclick="switchTab('scanner')">
        <div style="background:var(--primary); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: -15px auto 5px auto; box-shadow: 0 8px 20px rgba(0,85,255,0.4); color: white;">
            <i class="material-icons" style="margin:0; font-size: 24px;">qr_code_scanner</i>
        </div><span style="color:var(--primary); font-weight:bold;">Scan</span>
    </div>
    <div class="nav-item" onclick="switchTab('cart')"><i class="material-icons">shopping_bag</i><span>Carrello <b id="cart-badge" style="color:var(--danger); display:none">•</b></span></div>
    <div class="nav-item" onclick="switchTab('profile')"><i class="material-icons">person</i><span>Profilo</span></div>
</div>

<script>
    const database = [
        { id: '1', name: 'Pasta Barilla 500g', price: 1.20, barcode: '8076809513753', icon: 'restaurant', loc: {top:52, left:31} },
        { id: '2', name: 'Passata Mutti 700g', price: 1.45, barcode: '8005110170305', icon: 'local_dining', loc: {top:52, left:31} },
        { id: '3', name: 'Olio EVO Carapelli 1L', price: 6.99, barcode: '8002470001000', icon: 'liquor', loc: {top:60, left:31} },
        { id: '4', name: 'Riso Gallo 1kg', price: 2.80, barcode: '8001420000001', icon: 'grain', loc: {top:45, left:31} },
        { id: '5', name: 'Tonno Rio Mare 3x80g', price: 4.50, barcode: '8004030000001', icon: 'set_meal', loc: {top:55, left:31} },
        { id: '6', name: 'Nutella 750g', price: 6.50, discount: 4.99, barcode: '8000500003787', icon: 'cookie', loc: {top:52, left:50} },
        { id: '7', name: 'Biscotti Mulino Bianco', price: 2.99, barcode: '8076809500001', icon: 'cookie', loc: {top:52, left:50} },
        { id: '8', name: 'Caffè Lavazza 250g', price: 3.99, barcode: '8000000010001', icon: 'coffee', loc: {top:45, left:50} },
        { id: '9', name: 'Cereali Kellogg\'s', price: 3.50, barcode: '5053827000001', icon: 'breakfast_dining', loc: {top:45, left:50} },
        { id: '10', name: 'Marmellata Fragola', price: 2.20, barcode: '8001000000001', icon: 'kitchen', loc: {top:60, left:50} },
        { id: '11', name: 'Detersivo Dash 25 Lav.', price: 5.99, barcode: '8001090000001', icon: 'wash', loc: {top:60, left:69} },
        { id: '12', name: 'Shampoo Pantene', price: 3.20, barcode: '5410076000001', icon: 'shower', loc: {top:50, left:69} },
        { id: '13', name: 'Dentifricio Colgate', price: 1.80, barcode: '8718951000001', icon: 'clean_hands', loc: {top:45, left:69} },
        { id: '14', name: 'Carta Igienica 4 Rot.', price: 2.50, barcode: '8000000000002', icon: 'layers', loc: {top:55, left:69} },
        { id: '15', name: 'Sapone Mani Neutro', price: 1.50, barcode: '8000000000003', icon: 'soap', loc: {top:50, left:69} },
        { id: '16', name: 'Latte Granarolo 1L', price: 1.60, barcode: '8000000000004', icon: 'local_drink', loc: {top:45, left:8} },
        { id: '17', name: 'Mozzarella S.Lucia', price: 3.50, barcode: '8000000000005', icon: 'circle', loc: {top:50, left:8} },
        { id: '18', name: 'Yogurt Muller 2x125g', price: 1.20, barcode: '8000000000006', icon: 'icecream', loc: {top:40, left:8} },
        { id: '19', name: 'Uova Fresche 6pz', price: 2.10, barcode: '8000000000007', icon: 'egg', loc: {top:35, left:8} },
        { id: '20', name: 'Banane 1kg', price: 1.99, barcode: '8000000000008', icon: 'nightlife', loc: {top:82, left:15} },
        { id: '21', name: 'Mele Golden 1kg', price: 2.50, barcode: '8000000000009', icon: 'circle', loc: {top:82, left:15} },
        { id: '22', name: 'Insalata Iceberg', price: 1.20, barcode: '8000000000010', icon: 'park', loc: {top:88, left:15} },
        { id: '23', name: 'Acqua Nat. 6x1.5L', price: 2.40, barcode: '8002270014901', icon: 'water_drop', loc: {top:80, left:90} },
        { id: '24', name: 'Coca Cola 1.5L', price: 1.80, barcode: '5449000000996', icon: 'local_bar', loc: {top:80, left:90} },
        { id: '25', name: 'Birra Moretti 66cl', price: 1.30, barcode: '8001435000001', icon: 'sports_bar', loc: {top:85, left:90} },
        { id: '26', name: 'Petto di Pollo 500g', price: 5.50, barcode: '8000000000011', icon: 'restaurant', loc: {top:10, left:68} },
        { id: '27', name: 'Hamburger 2pz', price: 4.00, barcode: '8000000000012', icon: 'lunch_dining', loc: {top:10, left:68} },
        { id: '28', name: 'iPhone Case', price: 15.00, discount: 9.99, barcode: '444444', icon: 'smartphone', loc: {top:45, left:92} },
        { id: '29', name: 'Cuffie Sony', price: 35.00, barcode: '555555', icon: 'headphones', loc: {top:45, left:92} },
        { id: '30', name: 'Caricabatterie USB', price: 12.00, barcode: '666666', icon: 'electrical_services', loc: {top:55, left:92} }
    ];

    const freshProducts = [
        { id: 'f1', name: 'Pollo Arrosto', price: 8.50, icon: 'set_meal' },
        { id: 'f2', name: 'Lasagna alla Bolognese', price: 6.00, icon: 'restaurant' },
        { id: 'f3', name: 'Focaccia Barese', price: 3.50, icon: 'bakery_dining' },
        { id: 'f4', name: 'Insalata di Mare', price: 12.00, icon: 'sailing' }
    ];

    let cart = {};
    let scanner = null;
    let isScanning = false;
    let currentUser = null;
    let scanCooldown = false;
    let userReservations = [];
    let selectedServiceType = null;

    // --- LOGICA APP ---
    function createProductCard(p, isSearch = false) {
        const priceHTML = p.discount 
            ? `<span class="old-price">€${p.price.toFixed(2)}</span> <span class="price discounted">€${p.discount.toFixed(2)}</span>`
            : `<span class="price">€${p.price.toFixed(2)}</span>`;
        return `
        <div class="card">
            <div class="card-icon"><i class="material-icons">${p.icon}</i></div>
            <div class="info">
                <div class="name">${p.name}</div>
                <div>${priceHTML}</div>
                <button class="btn-map-mini" onclick="openMap('${p.id}')"><i class="material-icons" style="font-size:12px">place</i> TROVA</button>
            </div>
            ${isSearch ? `<button class="btn-map-mini" style="margin-left:5px; background:var(--primary); color:white" onclick="addToCart('${p.id}', 1)"><i class="material-icons" style="font-size:14px">add</i></button>` : ''}
        </div>`;
    }

    function renderFreshFood() {
        const container = document.getElementById('fresh-list');
        container.innerHTML = freshProducts.map(f => `
            <div class="food-item">
                <div class="food-img-ph"><i class="material-icons" style="font-size:40px">${f.icon}</i></div>
                <div class="food-info">
                    <div class="food-title">${f.name}</div>
                    <div style="font-weight:bold; color:#1a1a1a;">€ ${f.price.toFixed(2)}</div>
                    <button class="food-btn" onclick="bookItem('${f.id}')">PRENOTA</button>
                </div>
            </div>
        `).join('');
    }

    function bookItem(id) {
        const item = freshProducts.find(x => x.id === id);
        const time = document.getElementById('booking-time').value;
        if(confirm(`Prenotare ${item.name} per le ${time}?`)) {
            userReservations.push({ item: item, time: time, date: new Date() });
            alert("Prenotazione confermata!");
            closeSubPage();
            renderReservations();
        }
    }

    function renderReservations() {
        const list = document.getElementById('my-reservations-list');
        if(userReservations.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; margin-top:40px;">Nessuna prenotazione attiva</div>'; return; }
        list.innerHTML = userReservations.map(r => `
            <div class="order-card" style="border-left: 5px solid var(--warning);">
                <div class="order-head"><span>Ritiro ore ${r.time}</span> <span style="color:var(--text)">€ ${r.item.price.toFixed(2)}</span></div>
                <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">${r.item.name}</div>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">Reparto Gastronomia</div>
                <span class="status-badge status-pending">In Preparazione</span>
            </div>
        `).join('');
    }

    // --- NUOVA LOGICA: RENDER STORICO SPESE ---
    function renderHistory() {
        const list = document.getElementById('history-list');
        // Se non esiste lo storico o è vuoto
        if(!currentUser.history || currentUser.history.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; margin-top:40px;">Nessuna spesa passata</div>';
            return;
        }

        list.innerHTML = currentUser.history.map(trip => `
            <div class="order-card">
                <div class="order-head"><span>Spesa del ${trip.date}</span> <span style="color:var(--primary)">€ ${trip.total.toFixed(2)}</span></div>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">${trip.items} Articoli • ${trip.shop}</div>
                <span class="status-badge status-done">Completato</span>
            </div>
        `).join('');
    }

    function openMap(id) {
        const p = database.find(x=>x.id===id);
        const pin = document.getElementById('target-pin');
        pin.style.display = 'block';
        pin.style.top = p.loc.top + '%';
        pin.style.left = p.loc.left + '%';
        document.getElementById('map-modal').classList.add('active');
    }
    function closeMap() { document.getElementById('map-modal').classList.remove('active'); }

    function checkAuth() {
        const storedUser = localStorage.getItem('ynm_user_v3');
        if (storedUser) { 
            currentUser = JSON.parse(storedUser); 
            // Assicurati che l'array history esista
            if(!currentUser.history) currentUser.history = [];
            showApp(); 
        } else { 
            document.getElementById('view-login').classList.remove('hidden-auth'); 
        }
    }
    function toggleAuth(view) {
        document.getElementById('view-login').classList.add('hidden-auth'); document.getElementById('view-register').classList.add('hidden-auth');
        document.getElementById('view-' + view).classList.remove('hidden-auth');
    }
    function performLogin() {
        const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value;
        if(!email || !pass) { alert("Inserisci email e password"); return; }
        const savedStr = localStorage.getItem('ynm_db_' + email);
        if(!savedStr) { alert("Utente non trovato."); return; }
        const savedUser = JSON.parse(savedStr);
        if(savedUser.pass === pass) { 
            currentUser = savedUser; 
            if(!currentUser.history) currentUser.history = []; // Init history se manca
            finalizeLogin(); 
        } else { alert("Password errata!"); }
    }
    function performRegister() {
        const name = document.getElementById('reg-name').value; const email = document.getElementById('reg-email').value; const pass = document.getElementById('reg-pass').value;
        if(!name || !email || !pass) { alert("Compila tutti i campi"); return; }
        const newUser = { name: name, email: email, pass: pass, history: [] };
        localStorage.setItem('ynm_db_' + email, JSON.stringify(newUser)); currentUser = newUser; finalizeLogin();
    }
    function finalizeLogin() { localStorage.setItem('ynm_user_v3', JSON.stringify(currentUser)); location.reload(); }
    function doLogout() { if(confirm("Uscire?")) { localStorage.removeItem('ynm_user_v3'); location.reload(); } }
    
    function showApp() {
        document.querySelectorAll('.auth-page').forEach(el => el.style.display = 'none');
        document.getElementById('navbar').classList.remove('hidden'); document.getElementById('main-header').classList.remove('hidden');
        document.getElementById('user-name-display').innerText = currentUser.name; document.getElementById('user-email-display').innerText = currentUser.email;
        renderOffers(); renderFreshFood(); filterProducts(); initCrowd(); switchTab('offers');
    }

    function switchTab(tab) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + tab).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const map = {'offers':0, 'search':1, 'scanner':2, 'cart':3, 'profile':4};
        const navs = document.querySelectorAll('.nav-item'); if(navs[map[tab]]) navs[map[tab]].classList.add('active');
        if(tab === 'scanner') startScanner(); else stopScanner();
        if(tab === 'cart') renderCart();
        closeSubPage();
    }
    function openSubPage(id) { 
        document.getElementById('sub-' + id).classList.add('active'); 
        if(id === 'orders') renderHistory(); // Aggiorna lo storico quando apri la pagina
    }
    function closeSubPage() { document.querySelectorAll('.subpage').forEach(el => el.classList.remove('active')); }

    function renderOffers() {
        const offers = database.filter(p => p.discount);
        document.getElementById('offers-list').innerHTML = offers.map(p => createProductCard(p)).join('');
    }
    function filterProducts() {
        const q = document.getElementById('search-box').value.toLowerCase();
        const res = database.filter(p => p.name.toLowerCase().includes(q));
        const list = document.getElementById('products-list');
        list.innerHTML = res.length ? res.map(p => createProductCard(p, true)).join('') : '<div style="text-align:center;color:#999;padding:20px">Nessun prodotto trovato</div>';
    }

    function startScanner() {
        if(isScanning) return; isScanning = true;
        setTimeout(() => {
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScan)
            .catch(err => document.getElementById('scan-feedback').innerText="Camera Error");
        }, 500);
    }
    function stopScanner() { if(scanner && isScanning) { scanner.stop().then(()=>scanner.clear()); isScanning = false; } }
    function simulateScan(code) { onScan(code); }

    function onScan(code) {
        if(scanCooldown) return;
        const p = database.find(x=>x.barcode===code);
        const fb = document.getElementById('scan-feedback');
        const overlay = document.getElementById('scan-overlay');
        if(p) {
            scanCooldown = true; addToCart(p.id, 1);
            fb.innerHTML = `<span style="color:var(--success)">AGGIUNTO: ${p.name}</span>`;
            overlay.style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            setTimeout(() => { scanCooldown = false; fb.innerText = ""; overlay.style.display = 'none'; }, 2500);
        } else {
            scanCooldown = true; fb.innerText = "Non riconosciuto"; setTimeout(() => { scanCooldown = false; fb.innerText = ""; }, 2000);
        }
    }

    function addToCart(id, qty) { cart[id] = (cart[id]||0) + qty; if(cart[id]<=0) delete cart[id]; updateBadge(); if(document.getElementById('page-cart').classList.contains('active')) renderCart(); }
    function renderCart() {
        const list = document.getElementById('cart-list'); const footer = document.getElementById('cart-footer'); list.innerHTML = ''; let total = 0; const ids = Object.keys(cart);
        if(!ids.length) { list.innerHTML='<div style="text-align:center;padding:50px;color:#aaa">Carrello vuoto</div>'; footer.classList.add('hidden'); return; }
        ids.forEach(id => {
            const p = database.find(x=>x.id===id); const pr = p.discount||p.price; total += pr*cart[id];
            list.innerHTML += `<div class="card"><div class="info"><div class="name">${p.name}</div><div style="color:#888; font-size:12px">€ ${pr.toFixed(2)}</div></div><div class="qty-box"><div class="qty-btn" onclick="addToCart('${id}', -1)">-</div><div style="width:30px;text-align:center;font-weight:bold">${cart[id]}</div><div class="qty-btn" onclick="addToCart('${id}', 1)">+</div></div></div>`;
        });
        document.getElementById('total-price').innerText = "€ " + total.toFixed(2); footer.classList.remove('hidden');
    }
    function updateBadge() { document.getElementById('cart-badge').style.display = Object.keys(cart).length?'inline':'none'; }

    // --- NUOVA LOGICA DI PAGAMENTO E SERVIZI ---
    function pay() { 
        if(Object.keys(cart).length === 0) return;
        if(confirm('Confermi il pagamento?')) {
            // Invece di uscire subito, mostra la modale dei servizi
            document.getElementById('service-modal').style.display = 'flex';
        }
    }

    function processServiceChoice(type) {
        selectedServiceType = type;
        
        // Se sceglie 'none', esci subito
        if (type === 'none') {
            document.getElementById('service-modal').style.display = 'none';
            finalizeExit("Scansiona al tornello per uscire.");
            return;
        }

        // Evidenzia la scelta
        document.querySelectorAll('.service-option').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        // Mostra il form
        document.getElementById('cart-input-step').style.display = 'block';
        
        // Reset visibilità input
        document.getElementById('grp-cart').style.display = 'block';
        document.getElementById('grp-address').style.display = 'none';

        // Se consegna a casa, mostra anche l'indirizzo
        if (type === 'delivery') {
            document.getElementById('grp-address').style.display = 'block';
        }
        
        document.getElementById('service-cart-number').focus();
    }

    function confirmServiceWithCart() {
        const cartNum = document.getElementById('service-cart-number').value;
        if (!cartNum) { alert("Inserisci il numero del carrello."); return; }
        
        let address = "";
        if (selectedServiceType === 'delivery') {
            address = document.getElementById('service-address').value;
            if(!address) { alert("Inserisci l'indirizzo di spedizione."); return; }
        }

        document.getElementById('service-modal').style.display = 'none';
        
        let msg = "";
        if (selectedServiceType === 'car') {
            msg = `Lascia il carrello ${cartNum} all'area dedicata.\nRecati alla Piazzola di Carico con l'auto.`;
        } else if (selectedServiceType === 'delivery') {
            msg = `Lascia il carrello ${cartNum} all'area spedizioni.\nSpedizione a: ${address}`;
        }
        
        finalizeExit(msg);
    }

    function finalizeExit(message) {
        // --- NUOVO: SALVATAGGIO NELLO STORICO ---
        // Calcola totale e articoli
        let currentTotal = 0;
        let currentItems = 0;
        Object.keys(cart).forEach(id => {
            const p = database.find(x=>x.id===id);
            const pr = p.discount || p.price;
            currentTotal += pr * cart[id];
            currentItems += cart[id];
        });

        // Crea oggetto spesa
        const newTrip = {
            date: new Date().toLocaleDateString('it-IT'),
            total: currentTotal,
            items: currentItems,
            shop: "YourNextMarket Milano"
        };

        // Aggiungi all'inizio dell'array storico
        if(!currentUser.history) currentUser.history = [];
        currentUser.history.unshift(newTrip);

        // Salva in localStorage (sia sessione corrente che database persistente simulato)
        localStorage.setItem('ynm_user_v3', JSON.stringify(currentUser));
        localStorage.setItem('ynm_db_' + currentUser.email, JSON.stringify(currentUser));
        // ----------------------------------------

        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=EXIT-PASSPHRASE-" + Date.now();
        document.getElementById('qr-exit-img').src = qrUrl;
        document.getElementById('exit-msg').innerText = message;
        cart={}; updateBadge(); 
        document.getElementById('page-exit').classList.add('active');
    }

    function finishShopping() { document.getElementById('page-exit').classList.remove('active'); switchTab('offers'); }
    
    // --- CROWD WIDGET AGGIORNATO ---
    function initCrowd() { 
        setInterval(() => {
            const count = Math.floor(Math.random() * 101); 
            const label = document.getElementById('crowd-status'); 
            const dot = document.querySelector('.crowd-widget .dot'); 
            let color;
            
            if (count <= 50) color = '#2ed573'; 
            else if (count <= 75) color = '#ffa502'; 
            else color = '#ff4757';
            
            // Logica Responsive per il testo: se lo schermo è piccolo, accorcia
            if (window.innerWidth < 380) {
                label.innerText = count + " presenti"; 
            } else {
                label.innerText = "Affluenza:" + count + " utenti"; 
            }

            dot.style.background = color; 
            dot.style.boxShadow = `0 0 8px ${color}`;
        }, 4000); 
    }

    checkAuth();
</script>
</body>
</html>
